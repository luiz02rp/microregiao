---
title: "Untitled"
format: html
editor_options: 
  chunk_output_type: console
---


```{r}
library(tidyverse)
library(janitor)
library(rstatix)
library(flextable)
```

```{r}
df <- read_csv("data/dados-limpo.csv") 
```

```{r}
df_limpo <- df |> 
    filter(nivel_atencao %in% c("atenção primária", "atenção secundária", "atenção terciária"),
    codigo_municipio %in% c(230050, 230310, 230365, 230400, 230435, 230450, 230465, 230490, 230520, 230580, 230610, 230800, 230820, 230880, 230900, 230990, 231095, 231170, 231200, 231220, 231280, 231290, 231390, 231395)) |>
    select(nome, nome_do_municipio, codigo_municipio, populacao_muni, estabelecimento , nivel_atencao, codigo_estabelecimento_saude, codigo_profissional_saude, populacao_muni, cbo)
```

```{r}
df_analise <- df_limpo |> 
    select(nome, nome_do_municipio, nivel_atencao, populacao_muni) |>  
    group_by(nome_do_municipio, nivel_atencao, populacao_muni) |> 
    summarise(total_vinculos = n(), .groups = "drop") |> 
    mutate(pop_vinculo = populacao_muni / total_vinculos,
    nivel_atencao = as_factor(nivel_atencao)) 
```


```{r}
# quantidade de psicólogos por nível de atenção
df_limpo |> 
  count(nivel_atencao)

# quantidade de municípios
df_limpo |> 
  count(nome_do_municipio)

# códigos de profissionais repetidos
codigos_repetidos <- df_limpo |> 
  group_by(codigo_profissional_saude) |> 
  summarise(qde_vinculos = n()) |> 
  filter(qde_vinculos > 1) |> 
  arrange(desc(qde_vinculos)) |> 
  pull(codigo_profissional_saude) 

# detalhes dos profissionais repetidos
profissionais_repetidos <- df_limpo |> 
  filter(codigo_profissional_saude %in% c(codigos_repetidos)) |>  
  select(nome, nome_do_municipio, nivel_atencao, codigo_profissional_saude) |> 
  arrange(codigo_profissional_saude)

profissionais_repetidos |> 
  group_by(nivel_atencao) |> 
  summarise(n = n())

```

Encontrou-se 171 vínculos de psicólogos nos 24 municípios da 11º região de saúde. O nível primário, secundário e terciário contaram com, respectivamente, 96, 63 e 12 vínculos de psicólogos. A quantidade de vínculos repetidos foram 44, dos quais 32, 11 e 1 pertenciam, repectivamente, ao nível primário, secundário e terciário. 

```{r}
# tabela quantidade de psicólogos em cada município por nível assistencial
df_tabela <- df_analise |>  
    select(nome_do_municipio, nivel_atencao, total_vinculos) |> 
    arrange(desc(total_vinculos)) |> 
    pivot_wider(names_from = nivel_atencao, 
    values_from = total_vinculos,
    values_fill = 0) |> 
    clean_names() |> 
    mutate(vinculos_municipio = rowSums(across(starts_with("atencao_")), na.rm = T),
    porcentagem = vinculos_municipio / sum(vinculos_municipio))|> 
    as_data_frame() |> 
    relocate(atencao_primaria, .after = nome_do_municipio)

tabela <- df_tabela |> 
    adorn_totals("row", name = "Total") |> 
    flextable() |> 
    autofit() |> 
    colformat_double(j = "porcentagem", 
    digits = 0, suffix = "%") |>
    set_formatter(porcentagem = function(x) sprintf("%.0f%%", x * 100)) |> 
    set_caption("Distribuição dos vínculos de psicólogos na região de saúde 11")

tabela
```

Todos os municípios apresentaram psicólogos cadastrados, mas apenas Reriutaba e Sobral possuíam vínculos nos três níveis assistenciais, sendo este último o que contabilizou mais vínculos (34%) (Ver tabela X). 

```{r}
# banco para teste t
df_t <- df_analise |> 
    filter(nivel_atencao %in% c("atenção primária", "atenção secundária"))
```

```{r}
# banco para correlação
## correlação população e quantidade de vínculos de psicólogos
df_cor <- df_analise |> 
  select(nome_do_municipio, populacao_muni, total_vinculos) |> 
  group_by(nome_do_municipio, populacao_muni) |> 
  summarise(total_vinculos = sum(total_vinculos, na.rm = T), .groups = "drop")


## correlação população e quantidade de vínculos de psicólogos na atenção primária
df_cor_p <- df_analise |> 
    filter(nivel_atencao == "atenção primária") |> 
    select(populacao_muni, total_vinculos) 
    
## correlação população e quantidade de vínculos de psicólogos na atenção secundária
df_cor_s <- df_analise |>
    filter(nivel_atencao == "atenção secundária") |> 
    select(populacao_muni, total_vinculos) 
    
```

# Resultados
Encontrou-se 171 vínculos de psicólogos nos 24 municípios da 11º região de saúde. O nível primário, secundário e terciário contaram com, respectivamente, 96, 63 e 12 vínculos de psicólogos. A quantidade de vínculos repetidos foram 44, dos quais 32, 11 e 1 pertenciam, repectivamente, ao nível primário, secundário e terciário. Todos os municípios apresentaram psicólogos cadastrados, mas apenas Reriutaba e Sobral possuíam vínculos nos três níveis assistenciais, sendo este último o que contabilizou mais vínculos (34%) (Ver tabela X). 